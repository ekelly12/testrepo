# Test pipeline

trigger:
  - main

pool:
  vmImage: ubuntu-latest

stages:
  - stage: BuildAndTest
    displayName: "Build Enivornment (Ubuntu)"
    jobs:
      - job: CoreConfig
        displayName: "Configuring the system to core dump"
        steps:
          - bash: "./utils/setup.sh . $(Build.BinariesDirectory)"
            name: printvar
            displayName: "Setting up system-wide environment"
          - bash: "sudo sysctl -a | grep kernel.core_pattern"
            displayName: "Displaying kernel pattern"
          - bash: "./isegfault/build.sh . $(Build.BinariesDirectory)"
            displayName: "Building"
          - bash: "ls -la $(Build.BinariesDirectory)"
            displayName: "Dump of build bin folder"
          - bash: "./tests/isegfault-test.sh $(Build.BinariesDirectory)"
            displayName: "Segmentation fault test"
          - bash: "ls -l /tmp/core"
            displayName: "Contents of /tmp/core"
          - bash: "echo $(Build.BinariesDirectory) > utils/exec_paths.txt"
          - bash: "sudo apt install gdb"
            displayName: "This is dumb"
          - bash: "sudo which gdb"
            displayName: "any gdb?"
          - task: PythonScript@0
            displayName: 'Run error handler'
            inputs:
              scriptSource: 'filePath'
              scriptPath: ./utils/core-handler.py
              arguments: >- 
                reader 
                /tmp/core 
                utils/exec_paths.txt
    
